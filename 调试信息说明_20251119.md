# 调试信息说明

**日期**：2025-11-19  
**目的**：诊断网格配置更新问题

---

## 添加的调试信息

### 1. GridConfigPanel.qml

**位置**：Timer.onTriggered

**输出**：
```
GridConfigPanel: configChanged signal emitted {"rows":5,"columns":2,...}
```

**说明**：当用户修改配置后，Timer 触发时会输出新的配置。

### 2. ConfigEditor.qml - configChanged 连接

**位置**：gridConfigPanelLoader.onLoaded

**输出**：
```
ConfigEditor: received configChanged signal {"rows":5,"columns":2,...}
```

**说明**：ConfigEditor 接收到 GridConfigPanel 的 configChanged 信号。

### 3. ConfigManager.qml

**位置**：updateGridConfig 方法

**输出**：
```
ConfigManager: updateGridConfig called {"rows":5,"columns":2,...}
ConfigManager: emitting internalConfigChanged
```

**说明**：ConfigManager 更新配置并发出 internalConfigChanged 信号。

### 4. ConfigEditor.qml - internalConfigChanged 连接

**位置**：configManagerLoader.onLoaded

**输出**：
```
ConfigEditor: received internalConfigChanged {"rows":5,"columns":2,...}
ConfigEditor: updating GridPreview
```

或

```
ConfigEditor: received internalConfigChanged {"rows":5,"columns":2,...}
ConfigEditor: GridPreview not loaded yet
```

**说明**：ConfigEditor 接收到 ConfigManager 的 internalConfigChanged 信号，并尝试更新 GridPreview。

### 5. GridPreview.qml

**位置**：refresh 方法

**输出**：
```
GridPreview: refresh called, gridConfig = {"rows":5,"columns":2,...}
GridPreview: updating model from 8 to 10
```

**说明**：GridPreview 刷新，更新 Repeater 的 model。

---

## 正常的信号流程

当用户修改行数从 4 改为 5 时，应该看到以下输出：

```
1. GridConfigPanel: configChanged signal emitted {"rows":5,"columns":2,...}
2. ConfigEditor: received configChanged signal {"rows":5,"columns":2,...}
3. ConfigManager: updateGridConfig called {"rows":5,"columns":2,...}
4. ConfigManager: emitting internalConfigChanged
5. ConfigEditor: received internalConfigChanged {"rows":5,"columns":2,...}
6. ConfigEditor: updating GridPreview
7. GridPreview: refresh called, gridConfig = {"rows":5,"columns":2,...}
8. GridPreview: updating model from 8 to 10
```

---

## 可能的问题

### 问题 1：没有输出 1

**原因**：
- `isUpdating` 标志阻止了 updateConfig()
- Timer 没有触发
- SpinBox 的 onValueChanged 没有触发

**解决方案**：
- 检查 `isUpdating` 的值
- 检查 Timer 的 interval
- 检查 SpinBox 的绑定

### 问题 2：有输出 1，但没有输出 2

**原因**：
- configChanged 信号没有连接
- 信号连接在 GridConfigPanel 加载前

**解决方案**：
- 检查 gridConfigPanelLoader.onLoaded 中的连接
- 确保 configManager 已加载

### 问题 3：有输出 2，但没有输出 3

**原因**：
- ConfigManager 的 updateGridConfig 方法没有被调用
- 方法内部出错

**解决方案**：
- 检查方法调用
- 添加 try-catch 捕获错误

### 问题 4：有输出 3-4，但没有输出 5

**原因**：
- internalConfigChanged 信号没有连接
- 信号连接在 ConfigManager 加载前

**解决方案**：
- 检查 configManagerLoader.onLoaded 中的连接

### 问题 5：有输出 5，但显示 "GridPreview not loaded yet"

**原因**：
- GridPreview 还未加载
- gridPreviewLoader.item 为 null

**解决方案**：
- 检查 GridPreview 的加载状态
- 确保 gridPreviewLoader.active = true

### 问题 6：有输出 6，但没有输出 7-8

**原因**：
- GridPreview 的 refresh 方法没有被调用
- gridPreviewLoader.item 不是预期的对象

**解决方案**：
- 检查 gridPreviewLoader.item 的类型
- 确保 refresh 方法存在

### 问题 7：有输出 7-8，但界面没有更新

**原因**：
- Repeater 的 model 更新了，但没有重新渲染
- gridConfig 的属性绑定失效

**解决方案**：
- 检查 Repeater 的 delegate
- 检查 gridConfig 的绑定

---

## 调试步骤

### 步骤 1：启动应用并打开控制台

1. 启动应用
2. 打开 Qt Creator 的"应用程序输出"窗口
3. 或者在命令行运行应用查看输出

### 步骤 2：进入配置编辑器

1. 点击"新增表单"
2. 观察控制台输出

### 步骤 3：修改行数

1. 将行数从 4 改为 5
2. 观察控制台输出
3. 记录输出的序号（1-8）

### 步骤 4：分析输出

根据输出的序号，判断问题出在哪个环节：

- 只有 1：问题在 GridConfigPanel 和 ConfigEditor 之间
- 只有 1-2：问题在 ConfigEditor 和 ConfigManager 之间
- 只有 1-4：问题在 ConfigManager 和 ConfigEditor 之间
- 只有 1-6：问题在 ConfigEditor 和 GridPreview 之间
- 有 1-8：问题在 GridPreview 的渲染

### 步骤 5：修复问题

根据分析结果，修复对应的问题。

---

## 移除调试信息

问题修复后，可以移除调试信息：

### 方法 1：注释掉

```javascript
// console.log("GridConfigPanel: configChanged signal emitted", JSON.stringify(newConfig));
```

### 方法 2：使用条件编译

```javascript
if (false) {  // 设置为 false 禁用调试
    console.log("GridConfigPanel: configChanged signal emitted", JSON.stringify(newConfig));
}
```

### 方法 3：删除

直接删除 console.log 语句。

---

## 性能影响

### console.log 的开销

- 每次调用 console.log 都会：
  - 格式化字符串
  - 序列化对象（JSON.stringify）
  - 输出到控制台

- 在生产环境中应该移除或禁用

### JSON.stringify 的开销

- 对于大对象，JSON.stringify 可能很慢
- 建议只序列化必要的属性

```javascript
// ❌ 不推荐：序列化整个对象
console.log("Config:", JSON.stringify(currentConfig));

// ✅ 推荐：只序列化需要的属性
console.log("Grid:", JSON.stringify(currentConfig.grid));
```

---

## 总结

通过添加调试信息，我们可以：

1. 追踪信号的传播路径
2. 定位问题所在的环节
3. 验证修复是否有效

调试信息应该：
- 清晰明了
- 包含关键数据
- 易于定位问题

调试完成后应该：
- 移除或禁用调试信息
- 避免影响性能
- 保持代码整洁

---

**创建时间**：2025-11-19  
**用途**：诊断网格配置更新问题
