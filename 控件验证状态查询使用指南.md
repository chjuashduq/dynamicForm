# 控件验证状态查询使用指南

## 功能概述

新增了控件验证状态查询功能，可以在执行业务逻辑前检查相关字段是否都验证通过。

## 新增的 API 函数

### 1. isControlValid(controlKey)

检查单个控件是否验证通过。

**参数：**
- `controlKey` - 控件的 key

**返回值：**
- `true` - 控件验证通过
- `false` - 控件验证失败或未验证

**示例：**
```javascript
// 检查姓名是否验证通过
if (formAPI.isControlValid('name')) {
    console.log('姓名验证通过');
} else {
    console.log('姓名验证失败或未验证');
}
```

### 2. areControlsValid(controlKeys)

检查多个控件是否都验证通过。

**参数：**
- `controlKeys` - 控件 key 的数组，例如：`["name", "age", "email"]`

**返回值：**
- `true` - 所有控件都验证通过
- `false` - 至少有一个控件验证失败或未验证

**示例：**
```javascript
// 检查姓名、年龄、邮箱是否都验证通过
if (formAPI.areControlsValid(['name', 'age', 'email'])) {
    console.log('所有字段都验证通过');
} else {
    console.log('至少有一个字段验证失败');
}
```

### 3. getValidationState(controlKey)

获取控件的验证状态详细信息。

**参数：**
- `controlKey` - 控件的 key

**返回值：**
- `{valid: boolean, lastValidated: timestamp}` - 验证状态对象
- `null` - 控件未验证过

**示例：**
```javascript
var state = formAPI.getValidationState('name');
if (state) {
    console.log('验证状态:', state.valid);
    console.log('最后验证时间:', new Date(state.lastValidated));
} else {
    console.log('控件未验证过');
}
```

### 4. clearValidationState(controlKey)

清除控件的验证状态。

**参数：**
- `controlKey` - 控件的 key（可选，不提供则清除所有）

**示例：**
```javascript
// 清除单个控件的验证状态
formAPI.clearValidationState('name');

// 清除所有控件的验证状态
formAPI.clearValidationState();
```

## 使用场景

### 场景1：条件查询

当三个字段都验证通过时，执行数据库查询。

**配置：**
- name 控件：配置验证函数（长度验证）
- age 控件：配置验证函数（范围验证）
- city 控件：配置验证函数（必填验证）

**在某个控件的 onFocusLost 事件中：**
```javascript
// 检查三个字段是否都验证通过
if (formAPI.areControlsValid(['name', 'age', 'city'])) {
    // 所有字段都验证通过，执行查询
    var name = formAPI.getControlValue('name');
    var age = formAPI.getControlValue('age');
    var city = formAPI.getControlValue('city');
    
    var result = MySqlHelper.select(
        'users', 
        ['*'], 
        'name="' + name + '" AND age=' + age + ' AND city="' + city + '"'
    );
    
    if (result.length > 0) {
        formAPI.showMessage('找到 ' + result.length + ' 条匹配记录', 'success');
        console.log('查询结果:', JSON.stringify(result));
    } else {
        formAPI.showMessage('未找到匹配记录', 'info');
    }
} else {
    // 有字段未验证通过
    formAPI.showMessage('请先完成所有必填项的正确输入', 'warning');
}
```

### 场景2：动态启用按钮

根据验证状态动态启用/禁用提交按钮。

**在任意输入框的 onTextChanged 或 onValueChanged 事件中：**
```javascript
// 检查所有必填字段是否都验证通过
if (formAPI.areControlsValid(['name', 'age', 'email', 'phone'])) {
    // 所有字段都验证通过，启用提交按钮
    formAPI.enableControl('submitBtn');
    formAPI.showMessage('表单填写完成，可以提交', 'success');
} else {
    // 有字段未验证通过，禁用提交按钮
    formAPI.disableControl('submitBtn');
}
```

### 场景3：分步验证

在多步表单中，检查当前步骤的字段是否都验证通过。

**在"下一步"按钮的点击事件中：**
```javascript
// 第一步：基本信息
if (currentStep === 1) {
    if (!formAPI.areControlsValid(['name', 'age', 'gender'])) {
        formAPI.showMessage('请完成基本信息的填写', 'error');
        return;
    }
}

// 第二步：联系方式
if (currentStep === 2) {
    if (!formAPI.areControlsValid(['phone', 'email', 'address'])) {
        formAPI.showMessage('请完成联系方式的填写', 'error');
        return;
    }
}

// 进入下一步
currentStep++;
formAPI.showMessage('进入下一步', 'success');
```

### 场景4：实时反馈

在输入过程中实时显示验证进度。

**在任意输入框的 onFocusLost 事件中：**
```javascript
// 统计已验证通过的字段数量
var requiredFields = ['name', 'age', 'email', 'phone', 'address'];
var validCount = 0;

for (var i = 0; i < requiredFields.length; i++) {
    if (formAPI.isControlValid(requiredFields[i])) {
        validCount++;
    }
}

// 显示进度
var progress = Math.round((validCount / requiredFields.length) * 100);
formAPI.showMessage('表单完成度: ' + progress + '%', 'info');

// 如果全部完成
if (validCount === requiredFields.length) {
    formAPI.showMessage('所有必填项已完成！', 'success');
}
```

### 场景5：关联字段验证

当某个字段验证通过后，才允许填写关联字段。

**在 province（省份）控件的 onFocusLost 事件中：**
```javascript
// 检查省份是否验证通过
if (formAPI.isControlValid('province')) {
    // 省份验证通过，启用城市选择
    formAPI.enableControl('city');
    
    // 根据省份加载城市列表
    var province = formAPI.getControlValue('province');
    var cities = MySqlHelper.select('cities', ['name'], 'province="' + province + '"');
    
    // 更新城市下拉框选项（需要额外的API支持）
    formAPI.showMessage('请选择城市', 'info');
} else {
    // 省份未验证通过，禁用城市选择
    formAPI.disableControl('city');
    formAPI.setControlValue('city', '');
}
```

## 工作原理

### 验证状态缓存

每次执行验证时，验证结果会被缓存：

```javascript
validationStates = {
    "name": {
        valid: true,
        lastValidated: 1234567890123
    },
    "age": {
        valid: false,
        lastValidated: 1234567890456
    }
}
```

### 验证状态更新时机

验证状态会在以下情况下更新：
1. 失去焦点时自动验证
2. 调用 `validateControl()` 手动验证
3. 调用 `validateAll()` 验证所有控件

### 验证状态清除时机

验证状态会在以下情况下清除：
1. 调用 `clearValidationState()` 手动清除
2. 调用 `resetForm()` 重置表单（可选）

## 注意事项

### 1. 验证状态的时效性

验证状态是基于最后一次验证的结果，如果用户修改了输入但未失去焦点，验证状态不会更新。

**建议：**
- 在关键操作前，先调用 `validateControl()` 重新验证
- 或者在 `onTextChanged` 事件中清除验证状态

```javascript
// 在 onTextChanged 中清除验证状态
formAPI.clearValidationState('name');
```

### 2. 未验证的控件

如果控件从未验证过，`isControlValid()` 会返回 `false`。

**建议：**
- 使用 `getValidationState()` 区分"验证失败"和"未验证"
- 或者在检查前先调用 `validateControl()` 确保已验证

```javascript
var state = formAPI.getValidationState('name');
if (state === null) {
    console.log('控件未验证过');
} else if (!state.valid) {
    console.log('控件验证失败');
} else {
    console.log('控件验证通过');
}
```

### 3. 性能考虑

频繁调用 `areControlsValid()` 不会重新执行验证，只是查询缓存的状态，性能开销很小。

## 完整示例

### 示例：三个字段联合查询

**需求：**
- 姓名、年龄、城市三个字段都验证通过后，自动查询匹配的用户

**配置：**

1. **name 控件验证函数：**
```javascript
if (!value || value.trim() === '') {
    formAPI.showMessage('姓名不能为空', 'error');
    return false;
}
if (value.length < 2) {
    formAPI.showMessage('姓名至少2个字符', 'error');
    return false;
}
return true;
```

2. **age 控件验证函数：**
```javascript
if (!value || value < 18 || value > 100) {
    formAPI.showMessage('年龄必须在18-100之间', 'error');
    return false;
}
return true;
```

3. **city 控件验证函数：**
```javascript
if (!value || value.trim() === '') {
    formAPI.showMessage('城市不能为空', 'error');
    return false;
}
return true;
```

4. **在任意控件的 onFocusLost 事件中添加查询逻辑：**
```javascript
// 检查三个字段是否都验证通过
if (formAPI.areControlsValid(['name', 'age', 'city'])) {
    // 所有字段都验证通过，执行查询
    var name = formAPI.getControlValue('name');
    var age = formAPI.getControlValue('age');
    var city = formAPI.getControlValue('city');
    
    console.log('开始查询:', name, age, city);
    
    try {
        var result = MySqlHelper.select(
            'users', 
            ['id', 'name', 'age', 'city', 'phone'], 
            'name="' + name + '" AND age=' + age + ' AND city="' + city + '"'
        );
        
        if (result.length > 0) {
            formAPI.showMessage('找到 ' + result.length + ' 条匹配记录', 'success');
            console.log('查询结果:', JSON.stringify(result));
            
            // 可以将结果显示在其他控件中
            if (result.length === 1) {
                formAPI.setControlValue('phone', result[0].phone);
            }
        } else {
            formAPI.showMessage('未找到匹配记录', 'info');
        }
    } catch (e) {
        formAPI.showMessage('查询失败: ' + e, 'error');
        console.error('查询错误:', e);
    }
} else {
    console.log('有字段未验证通过，跳过查询');
}
```

## 总结

新增的验证状态查询功能让你可以：

1. ✅ 检查单个或多个控件的验证状态
2. ✅ 在执行业务逻辑前确保数据有效
3. ✅ 实现条件查询、动态启用按钮等高级功能
4. ✅ 提供更好的用户体验和数据安全性

通过合理使用这些 API，可以构建更加智能和健壮的表单系统。
