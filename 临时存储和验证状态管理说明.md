# 临时存储和验证状态管理说明

## 更新内容

### 1. 验证状态自动清空 ✅

**问题**：某些组件在第一次验证通过后，退出再次进入时，即使没有输入内容，验证状态仍然是true。

**解决方案**：
- 每次进入表单时（调用`initForm`或`initFormForEdit`），自动清空所有控件的验证状态
- 验证状态缓存`validationStates`会被重置为空对象
- 确保每次进入表单都是全新的验证状态

**实现位置**：
- `FormAPI.qml` - 添加了`initializeForm()`函数
- `ScriptEngine.qml` - 添加了`initializeEngine()`函数
- `FormPreview.qml` - 在`initForm()`和`initFormForEdit()`中调用初始化

---

### 2. 临时存储功能 ✅

**功能**：实现同一表单各个事件间的数据暂存。

**使用场景**：
- 在一个事件中保存数据，在另一个事件中使用
- 跨控件的数据传递
- 临时计算结果的存储
- 用户选择的中间状态保存

**API函数**：

#### `setTempValue(key, value)`
设置临时存储的值

```javascript
// 在下拉框的onValueChanged事件中
setTempValue('selectedCountry', getControlValue('country'));
setTempValue('lastModified', formatDateTime());
```

#### `getTempValue(key)`
获取临时存储的值

```javascript
// 在另一个控件的事件中
var country = getTempValue('selectedCountry');
if (country === '00') {
    showMessage('您之前选择了中国', 'info');
}

var lastTime = getTempValue('lastModified');
console.log('上次修改时间:', lastTime);
```

#### `clearTempStorage(key)`
清除临时存储

```javascript
// 清除单个键
clearTempStorage('selectedCountry');

// 清除所有临时存储
clearTempStorage();
```

---

## 使用示例

### 示例1：下拉框联动

```javascript
// 国家下拉框的 onValueChanged 事件
var country = getControlValue('country');
setTempValue('currentCountry', country);

if (country === '00') {
    // 中国
    enableControl('province');
    showControl('idCard');
} else {
    disableControl('province');
    hideControl('idCard');
}
```

```javascript
// 省份下拉框的 onValueChanged 事件
var country = getTempValue('currentCountry');
var province = getControlValue('province');

console.log('当前国家:', country, '当前省份:', province);

// 根据国家和省份做进一步处理
if (country === '00' && province === '11') {
    showMessage('您选择了北京', 'info');
}
```

### 示例2：多步骤表单

```javascript
// 第一步：保存用户选择
setTempValue('step1_completed', true);
setTempValue('userType', getControlValue('userType'));
setTempValue('startTime', formatDateTime());
```

```javascript
// 第二步：检查前置条件
if (!getTempValue('step1_completed')) {
    showMessage('请先完成第一步', 'warning');
    return false;
}

var userType = getTempValue('userType');
if (userType === 'vip') {
    // VIP用户特殊处理
    enableControl('vipOptions');
}
```

### 示例3：提交前清理

```javascript
// 提交按钮的 onClick 事件
var validation = validateAll();
if (!validation.valid) {
    return;
}

// 提交数据...
var result = MySqlHelper.insert('users', formData);

if (result) {
    showMessage('提交成功！', 'success');
    resetForm();
    // 清除所有临时存储
    clearTempStorage();
}
```

---

## 注意事项

1. **临时存储的生命周期**：
   - 临时存储在表单初始化时自动清空
   - 每次进入表单（新增或编辑）都会重置
   - 不会持久化到数据库

2. **验证状态管理**：
   - 验证状态在表单初始化时自动清空
   - 每次失去焦点时会重新验证
   - 可以使用`isControlValid(key)`检查验证状态

3. **最佳实践**：
   - 使用有意义的key名称，如`'selectedCountry'`而不是`'temp1'`
   - 在不需要时及时清除临时存储
   - 避免存储大量数据，临时存储适合小数据量

---

## 技术实现

### FormAPI.qml
- 添加了`tempStorage`属性用于存储临时数据
- 添加了`initializeForm()`函数清空验证状态和临时存储
- 添加了`setTempValue()`、`getTempValue()`、`clearTempStorage()`三个API函数

### ScriptEngine.qml
- 添加了`initializeEngine()`函数调用FormAPI的初始化
- 在`executeFunction()`中注入了临时存储相关的API函数

### FormPreview.qml
- 在`initForm()`和`initFormForEdit()`中调用`scriptEngine.initializeEngine()`
- 确保每次进入表单都会清空验证状态和临时存储

---

## 更新日期
2025-11-19
