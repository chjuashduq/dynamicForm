# 表单验证功能说明

## 功能概述

表单验证系统提供了完整的输入验证和视觉反馈功能，包括：

1. ✅ 失去焦点时自动验证
2. ✅ 验证失败时标签标红
3. ✅ 验证成功时标签恢复原色
4. ✅ 提交时验证所有控件
5. ✅ 验证失败时阻止 onFocusLost 事件执行
6. ✅ 自定义验证函数支持

## 工作流程

### 1. 失去焦点时的验证流程

```
用户输入 → 失去焦点 → 执行验证函数
                          ↓
                    验证成功？
                    ↙     ↘
                  是       否
                  ↓        ↓
            标签恢复原色  标签变红
            执行onFocusLost  显示错误消息
            事件           跳过onFocusLost
```

**关键特性：**
- 只有验证成功时才执行 `onFocusLost` 事件
- 验证失败时会阻止后续事件执行
- 这样可以避免在数据不合法时执行数据库操作

### 2. 提交时的验证流程

```
点击提交按钮 → 验证所有控件
                    ↓
              所有验证通过？
              ↙         ↘
            是           否
            ↓            ↓
      所有标签恢复原色   失败的标签变红
      执行提交函数       显示错误汇总
                        聚焦第一个错误
                        阻止提交
```

## 验证函数编写规范

### 基本结构

```javascript
if (验证条件不满足) {
    formAPI.showMessage('错误消息', 'error');
    return false;  // 验证失败
}
return true;  // 验证成功
```

### 重要规则

1. **必须调用 `formAPI.showMessage()`**
   - 验证失败时必须显示错误消息
   - 否则用户不知道为什么验证失败

2. **必须返回布尔值**
   - `return true` 表示验证成功
   - `return false` 表示验证失败

3. **可以使用多个条件**
   - 按顺序检查多个条件
   - 遇到第一个失败就返回

### 示例：完整的验证函数

```javascript
// 姓名验证
if (!value || value.trim() === '') {
    formAPI.showMessage('姓名不能为空', 'error');
    return false;
}
if (value.length < 2) {
    formAPI.showMessage('姓名长度不能少于2个字符', 'error');
    return false;
}
if (value.length > 20) {
    formAPI.showMessage('姓名长度不能超过20个字符', 'error');
    return false;
}
return true;
```

## 视觉反馈

### 标签颜色变化

| 状态 | 颜色 | 说明 |
|------|------|------|
| 初始状态 | 黑色或配置的颜色 | 未验证 |
| 验证成功 | 黑色或配置的颜色 | 恢复原色 |
| 验证失败 | 红色 (#ff0000) | 标红提示 |

### 错误消息显示

- **失去焦点验证**：显示单个字段的错误消息
- **提交验证**：显示错误汇总（最多3个字段）

```
表单验证失败，请检查以下字段：
• 姓名
• 年龄
• 邮箱
```

## 事件执行顺序

### 失去焦点时

```
1. 触发 focusChanged 事件
2. 执行验证函数（如果配置了）
3. 更新标签颜色
4. 如果验证成功：
   - 执行 onFocusLost 事件（如果配置了）
5. 如果验证失败：
   - 跳过 onFocusLost 事件
```

### 提交时

```
1. 触发按钮点击事件
2. 验证所有控件
3. 更新所有标签颜色
4. 如果所有验证通过：
   - 执行提交函数
5. 如果有验证失败：
   - 显示错误汇总
   - 聚焦第一个错误字段
   - 阻止提交函数执行
```

## 可用的 API

### 验证相关

```javascript
// 验证单个控件
formAPI.validateControl(controlKey)

// 验证所有控件
formAPI.validateAll()

// 内置验证函数
formAPI.validateEmail(value)      // 验证邮箱
formAPI.validatePhone(value)      // 验证手机号
formAPI.validateIdCard(value)     // 验证身份证
formAPI.validateChinese(value)    // 验证中文
formAPI.validateNumber(value, min, max)  // 验证数字范围
```

### 消息显示

```javascript
// 显示消息
formAPI.showMessage(message, type)

// type 可选值：
// - "info"    信息（蓝色）
// - "success" 成功（绿色）
// - "error"   错误（红色）
// - "warning" 警告（橙色）
```

### 控件操作

```javascript
// 获取控件值
formAPI.getControlValue(controlKey)

// 设置控件值
formAPI.setControlValue(controlKey, value)

// 获取所有控件的值
formAPI.getAllValues()

// 让控件获得焦点
formAPI.focusControl(controlKey)
```

## 常见使用场景

### 场景1：必填验证

```javascript
if (!value || value.trim() === '') {
    formAPI.showMessage('此字段不能为空', 'error');
    return false;
}
return true;
```

### 场景2：长度验证

```javascript
if (value.length < 6 || value.length > 20) {
    formAPI.showMessage('长度必须在6-20个字符之间', 'error');
    return false;
}
return true;
```

### 场景3：格式验证

```javascript
// 邮箱
if (!formAPI.validateEmail(value)) {
    return false;  // validateEmail 内部已显示消息
}
return true;

// 手机号
if (!formAPI.validatePhone(value)) {
    return false;
}
return true;
```

### 场景4：关联验证

```javascript
// 确认密码
var password = formAPI.getControlValue('password');
if (value !== password) {
    formAPI.showMessage('两次密码输入不一致', 'error');
    return false;
}
return true;
```

### 场景5：条件验证

```javascript
// 年龄必须大于18岁
if (value < 18) {
    formAPI.showMessage('年龄必须大于18岁', 'error');
    return false;
}

// 如果选择了"其他"，必须填写备注
var type = formAPI.getControlValue('type');
if (type === 'other' && (!value || value.trim() === '')) {
    formAPI.showMessage('选择"其他"时必须填写备注', 'error');
    return false;
}
return true;
```

## 最佳实践

### 1. 验证函数要简洁明了

```javascript
// ✅ 好的写法
if (!value || value.trim() === '') {
    formAPI.showMessage('姓名不能为空', 'error');
    return false;
}
if (value.length < 2) {
    formAPI.showMessage('姓名至少2个字符', 'error');
    return false;
}
return true;

// ❌ 不好的写法（太复杂）
var isValid = true;
var errorMsg = '';
if (!value) {
    isValid = false;
    errorMsg = '姓名不能为空';
} else if (value.trim() === '') {
    isValid = false;
    errorMsg = '姓名不能为空';
} else if (value.length < 2) {
    isValid = false;
    errorMsg = '姓名至少2个字符';
}
if (!isValid) {
    formAPI.showMessage(errorMsg, 'error');
}
return isValid;
```

### 2. 错误消息要清晰具体

```javascript
// ✅ 好的消息
formAPI.showMessage('密码长度必须在6-20个字符之间', 'error');

// ❌ 不好的消息
formAPI.showMessage('输入错误', 'error');
formAPI.showMessage('验证失败', 'error');
```

### 3. 使用内置验证函数

```javascript
// ✅ 使用内置函数
if (!formAPI.validateEmail(value)) {
    return false;
}

// ❌ 自己写正则（容易出错）
var regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
if (!regex.test(value)) {
    formAPI.showMessage('邮箱格式不正确', 'error');
    return false;
}
```

### 4. 验证失败时不执行业务逻辑

```javascript
// ✅ 好的做法：在 onFocusLost 中执行业务逻辑
// 验证函数只负责验证
if (!value || value.length < 2) {
    formAPI.showMessage('姓名至少2个字符', 'error');
    return false;
}
return true;

// onFocusLost 事件中执行数据库查询
var result = MySqlHelper.select('users', ['id'], 'name="' + value + '"');
if (result.length > 0) {
    formAPI.showMessage('该姓名已存在', 'warning');
}

// ❌ 不好的做法：在验证函数中执行业务逻辑
if (!value || value.length < 2) {
    formAPI.showMessage('姓名至少2个字符', 'error');
    return false;
}
// 不要在这里查询数据库！
var result = MySqlHelper.select('users', ['id'], 'name="' + value + '"');
if (result.length > 0) {
    formAPI.showMessage('该姓名已存在', 'error');
    return false;
}
return true;
```

## 调试技巧

### 1. 添加日志

```javascript
console.log('开始验证姓名，值为:', value);
if (!value || value.trim() === '') {
    console.log('验证失败：姓名为空');
    formAPI.showMessage('姓名不能为空', 'error');
    return false;
}
console.log('验证成功');
return true;
```

### 2. 查看控制台日志

关键日志信息：
- `Validating text on focus lost: xxx` - 开始验证
- `Text validation result: true/false` - 验证结果
- `Executing custom onFocusLost for: xxx` - 执行自定义事件
- `Validation failed, skipping custom onFocusLost` - 验证失败，跳过事件

### 3. 测试边界情况

- 空值
- 空格
- 最小长度
- 最大长度
- 特殊字符
- 中文字符

## 总结

表单验证系统提供了完整的验证和反馈机制：

1. **自动验证**：失去焦点时自动执行
2. **视觉反馈**：标签颜色变化
3. **错误提示**：清晰的错误消息
4. **事件控制**：验证失败时阻止后续事件
5. **提交保护**：验证失败时阻止提交

通过合理使用验证函数和事件，可以构建健壮的表单系统。
