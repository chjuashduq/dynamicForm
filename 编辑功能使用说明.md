# 编辑功能使用说明

## ✅ 已完成的功能

### 1. 修复数据内容显示
**问题：** 数据记录列表中的"数据内容"列显示为空

**解决方案：**
- 检查 data 字段类型，如果是对象则转换为 JSON 字符串
- 确保数据正确显示在列表中

**代码：**
```javascript
for (var i = 0; i < result.length; i++) {
    var dataStr = result[i].data || "{}";
    // 如果 data 是对象，转换为 JSON 字符串
    if (typeof dataStr === "object") {
        dataStr = JSON.stringify(dataStr);
    }
    
    dataRecordModel.append({
        id: result[i].id,
        dynamicId: result[i].dynamicId,
        data: dataStr,
        createTime: result[i].createTime || ""
    });
}
```

### 2. 实现编辑功能
**新增功能：**
- ✅ 编辑模式支持
- ✅ 自动填充现有数据
- ✅ 区分新增和编辑操作
- ✅ 编辑时使用 UPDATE 而不是 INSERT

## 📊 编辑功能架构

### 新增属性

#### FormPreview.qml
```qml
property int dataRecordId: -1      // 数据记录ID（编辑模式）
property var initialData: ({})      // 初始数据（编辑模式）
property bool isEditMode: false     // 是否为编辑模式
```

#### ScriptEngine.qml
```qml
property int dataRecordId: -1      // 数据记录ID（编辑模式）
property bool isEditMode: false     // 是否为编辑模式
```

### 新增函数

#### FormPreview.qml

**initFormForEdit** - 初始化编辑模式
```javascript
function initFormForEdit(id, name, configJson, recordDataId, dataJson) {
    recordId = id                    // 表单ID
    formName = name                  // 表单名称
    isEditMode = true                // 设置为编辑模式
    dataRecordId = recordDataId      // 数据记录ID
    
    // 解析初始数据
    initialData = JSON.parse(dataJson)
    
    // 解析表单配置
    formConfig = JSON.parse(configJson)
    
    // 延迟填充数据
    Qt.callLater(fillFormData)
}
```

**fillFormData** - 填充表单数据
```javascript
function fillFormData() {
    for (var key in initialData) {
        formAPI.setControlValue(key, initialData[key])
    }
}
```

## 🔄 工作流程

### 新增记录流程
```
数据记录列表
    ↓ 点击"新增记录"
FormPreview（新增模式）
    ↓ isEditMode = false
    ↓ dataRecordId = -1
    ↓ 填写表单
    ↓ 点击提交按钮
执行 INSERT 操作
    ↓
返回数据记录列表
```

### 编辑记录流程
```
数据记录列表
    ↓ 点击"编辑"
FormPreview（编辑模式）
    ↓ isEditMode = true
    ↓ dataRecordId = 记录ID
    ↓ 自动填充现有数据
    ↓ 修改表单
    ↓ 点击提交按钮
执行 UPDATE 操作
    ↓
返回数据记录列表
```

## 💾 数据库操作

### 提交按钮的点击事件

用户需要在按钮的点击事件中判断是新增还是编辑：

```javascript
// 验证表单
var validation = validateAll();
if (!validation.valid) {
    return; // 验证失败
}

// 准备数据
var submitData = {
    dynamicId: formId,
    data: JSON.stringify(formData),
    createTime: new Date().toISOString()
};

try {
    if (isEditMode) {
        // 编辑模式：UPDATE
        var where = "id=" + dataRecordId;
        MySqlHelper.update("dynamicData", submitData, where);
        showMessage("更新成功！", "success");
    } else {
        // 新增模式：INSERT
        MySqlHelper.insert("dynamicData", submitData);
        showMessage("提交成功！", "success");
    }
} catch(e) {
    showMessage("操作失败: " + e, "error");
}
```

## 📝 可用变量

在按钮的点击事件中，现在可以使用以下新变量：

### dataRecordId
- **类型：** number
- **说明：** 数据记录的ID（编辑模式）
- **值：** 
  - 新增模式：-1
  - 编辑模式：实际的记录ID

### isEditMode
- **类型：** boolean
- **说明：** 是否为编辑模式
- **值：**
  - 新增模式：false
  - 编辑模式：true

## 🎯 使用示例

### 示例1：智能提交按钮

```javascript
// 验证所有字段
var validation = validateAll();
if (!validation.valid) {
    return;
}

// 准备提交数据
var submitData = {
    dynamicId: formId,
    data: JSON.stringify(formData)
};

try {
    if (isEditMode) {
        // 编辑模式：更新现有记录
        var where = "id=" + dataRecordId;
        MySqlHelper.update("dynamicData", submitData, where);
        showMessage("更新成功！", "success");
    } else {
        // 新增模式：插入新记录
        submitData.createTime = new Date().toISOString();
        MySqlHelper.insert("dynamicData", submitData);
        showMessage("提交成功！", "success");
    }
    
    // 返回列表页面
    // TODO: 添加返回逻辑
} catch(e) {
    showMessage("操作失败: " + e, "error");
}
```

### 示例2：显示不同的按钮文本

虽然不能直接在配置中使用 isEditMode，但可以在点击事件中根据模式显示不同的消息：

```javascript
var actionText = isEditMode ? "更新" : "提交";
showMessage(actionText + "成功！", "success");
```

### 示例3：编辑时的额外验证

```javascript
// 验证表单
var validation = validateAll();
if (!validation.valid) {
    return;
}

// 编辑模式下的额外检查
if (isEditMode) {
    // 检查是否有修改
    var hasChanges = false;
    // TODO: 实现变更检测逻辑
    
    if (!hasChanges) {
        showMessage("没有任何修改", "info");
        return;
    }
}

// 提交数据
// ...
```

## 🔍 数据填充机制

### 自动填充
编辑模式下，FormPreview 会自动填充数据：

1. 解析 dataJson 为 initialData 对象
2. 等待表单加载完成（使用 Qt.callLater）
3. 遍历 initialData，调用 formAPI.setControlValue 填充每个控件

### 支持的控件类型
- ✅ TextField（文本输入框）
- ✅ SpinBox（数字输入框）
- ✅ ComboBox（下拉框）
- ✅ CheckBox（复选框）
- ✅ RadioButton（单选框）

## ⚠️ 注意事项

### 1. 按钮配置
提交按钮的点击事件需要判断 isEditMode：

```javascript
if (isEditMode) {
    // UPDATE 逻辑
} else {
    // INSERT 逻辑
}
```

### 2. 数据格式
data 字段存储的是 JSON 字符串：
```json
{
    "name": "张三",
    "age": 25,
    "email": "zhangsan@example.com"
}
```

### 3. 返回列表
编辑完成后，需要返回数据记录列表并刷新：
```javascript
// TODO: 实现返回逻辑
// 可以通过 stackViewRef.pop() 返回
// 然后调用列表的 loadData() 刷新
```

### 4. createTime 字段
- 新增时：设置 createTime
- 编辑时：不修改 createTime（保持原值）

## 📋 完整示例

### 提交按钮配置

```javascript
// 验证所有字段
var validation = validateAll();
if (!validation.valid) {
    return; // 验证失败，已显示错误
}

// 准备提交数据
var submitData = {
    dynamicId: formId,
    data: JSON.stringify(formData)
};

try {
    if (isEditMode) {
        // ========== 编辑模式 ==========
        var where = "id=" + dataRecordId;
        MySqlHelper.update("dynamicData", submitData, where);
        showMessage("更新成功！", "success");
    } else {
        // ========== 新增模式 ==========
        submitData.createTime = new Date().toISOString();
        MySqlHelper.insert("dynamicData", submitData);
        showMessage("提交成功！", "success");
    }
    
    // 清空表单
    resetForm();
    
    // TODO: 返回列表页面
    // stackViewRef.pop();
    
} catch(e) {
    showMessage("操作失败: " + e, "error");
    console.error("Submit error:", e);
}
```

## 🚀 测试步骤

### 测试新增功能
1. 在数据记录列表点击"新增记录"
2. 填写表单
3. 点击提交
4. 验证数据是否插入到 dynamicData 表

### 测试编辑功能
1. 在数据记录列表点击某条记录的"编辑"
2. 验证表单是否自动填充了现有数据
3. 修改某些字段
4. 点击提交
5. 验证数据是否更新到 dynamicData 表

### 测试验证功能
1. 在编辑模式下，清空某个必填字段
2. 失去焦点或点击提交
3. 验证是否显示错误消息
4. 验证标签是否变红

## 总结

编辑功能已完成：
1. ✅ 数据内容正确显示
2. ✅ 编辑模式支持
3. ✅ 自动填充现有数据
4. ✅ 区分新增和编辑操作
5. ✅ 提供 isEditMode 和 dataRecordId 变量
6. ✅ 支持 UPDATE 和 INSERT 操作

**重新编译项目后即可使用！** 🎉
