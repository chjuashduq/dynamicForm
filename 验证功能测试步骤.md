# 验证功能测试步骤

## 测试前准备

### 1. 确保验证函数正确编写

验证函数**必须**调用 `formAPI.showMessage()` 来显示错误消息！

**正确的验证函数示例：**

```javascript
// name 控件的验证函数
if (!value || value.trim() === '') {
    formAPI.showMessage('姓名不能为空', 'error');
    return false;
}
if (value.length < 2) {
    formAPI.showMessage('姓名长度不能少于2个字符', 'error');
    return false;
}
return true;
```

```javascript
// age 控件的验证函数
if (!value || value < 18 || value > 100) {
    formAPI.showMessage('年龄必须在18-100之间', 'error');
    return false;
}
return true;
```

```javascript
// email 控件的验证函数
if (!value || value.trim() === '') {
    formAPI.showMessage('邮箱不能为空', 'error');
    return false;
}
if (!formAPI.validateEmail(value)) {
    // validateEmail 内部已经显示了消息
    return false;
}
return true;
```

### 2. 检查配置

打开配置编辑器，编辑每个需要验证的控件：
1. 点击"验证函数"标签
2. 在文本框中输入验证函数代码
3. 确保代码中包含 `formAPI.showMessage()`
4. 点击"保存"

## 测试步骤

### 测试1：失去焦点时的验证

1. 打开表单填写页面
2. 在 name 输入框中输入一个字符（如 "1"）
3. 点击其他输入框（让 name 失去焦点）
4. **预期结果：**
   - 控制台显示：`Validating text on focus lost: name`
   - 显示错误消息：`姓名长度不能少于2个字符`
   - name 标签变红
   - 如果配置了 onFocusLost 事件，会显示：`Executing custom onFocusLost for: name`

5. 在 name 输入框中输入正确的值（如 "张三"）
6. 点击其他输入框
7. **预期结果：**
   - 不显示错误消息
   - name 标签恢复原色（黑色或配置的颜色）

### 测试2：数字输入框的验证

1. 在 age 输入框中输入 10
2. 点击其他输入框
3. **预期结果：**
   - 控制台显示：`Validating number on focus lost: age`
   - 显示错误消息：`年龄必须在18-100之间`
   - age 标签变红

4. 在 age 输入框中输入 25
5. 点击其他输入框
6. **预期结果：**
   - 不显示错误消息
   - age 标签恢复原色

### 测试3：提交时的验证

1. 填写表单，故意让某些字段验证失败（如 name 输入 "1"，age 输入 10）
2. 点击"提交"按钮
3. **预期结果：**
   - 控制台显示：`validateAll called`
   - 显示错误汇总消息：
     ```
     表单验证失败，请检查以下字段：
     • 姓名
     • 年龄
     ```
   - 所有验证失败的标签都变红
   - 第一个错误字段获得焦点

4. 修正所有错误
5. 再次点击"提交"按钮
6. **预期结果：**
   - 所有标签恢复原色
   - 执行提交函数（如显示"提交成功"）

### 测试4：焦点失去事件是否执行

如果你在配置中为 name 控件设置了 `onFocusLost` 事件（如数据库查询），测试：

**情况1：验证成功时**
1. 在 name 输入框中输入正确的值（如 "张三"）
2. 点击其他输入框
3. **预期结果：**
   - 先执行验证
   - 验证通过
   - 然后执行 onFocusLost 事件
   - 控制台显示：`Executing custom onFocusLost for: name`
   - 显示数据库查询结果

**情况2：验证失败时**
1. 在 name 输入框中输入错误的值（如 "1"）
2. 点击其他输入框
3. **预期结果：**
   - 先执行验证
   - 验证失败
   - 显示错误消息
   - 标签变红
   - **不执行** onFocusLost 事件
   - 控制台显示：`Validation failed, skipping custom onFocusLost for: name`

## 常见问题排查

### 问题1：验证消息不显示

**原因：** 验证函数没有调用 `formAPI.showMessage()`

**解决：** 在验证函数中添加：
```javascript
formAPI.showMessage('错误消息', 'error');
```

### 问题2：标签不变红

**原因：** 可能是验证函数有语法错误

**解决：** 
1. 查看控制台是否有错误日志
2. 检查验证函数语法
3. 确保返回 `false` 时表示验证失败

### 问题3：焦点失去事件不执行

**原因：** 可能是 `config.events.onFocusLost` 没有配置

**解决：**
1. 检查控制台日志：`No custom onFocusLost event for: xxx`
2. 在配置编辑器中为控件添加 onFocusLost 事件

### 问题4：提交时不验证

**原因：** 按钮的"按钮动作"没有设置为"提交"

**解决：**
1. 编辑提交按钮
2. 在"按钮动作"面板中选择"提交"类型

## 调试技巧

### 查看控制台日志

关键日志信息：
- `Focus lost for text: xxx` - 文本框失去焦点
- `Validating text on focus lost: xxx` - 开始验证
- `Text validation result: true/false` - 验证结果
- `Executing custom onFocusLost for: xxx` - 执行自定义事件
- `validateAll called` - 提交时验证所有控件

### 验证函数调试

在验证函数中添加日志：
```javascript
console.log('验证 name，值为:', value);
if (!value || value.trim() === '') {
    console.log('验证失败：姓名为空');
    formAPI.showMessage('姓名不能为空', 'error');
    return false;
}
console.log('验证成功');
return true;
```

## 完整的验证函数模板

### 必填验证
```javascript
if (!value || value.trim() === '') {
    formAPI.showMessage('此字段不能为空', 'error');
    return false;
}
return true;
```

### 长度验证
```javascript
if (!value || value.length < 6) {
    formAPI.showMessage('长度不能少于6个字符', 'error');
    return false;
}
return true;
```

### 数字范围验证
```javascript
if (!value || value < 18 || value > 100) {
    formAPI.showMessage('数值必须在18-100之间', 'error');
    return false;
}
return true;
```

### 邮箱验证
```javascript
if (!value || value.trim() === '') {
    formAPI.showMessage('邮箱不能为空', 'error');
    return false;
}
if (!formAPI.validateEmail(value)) {
    return false;  // validateEmail 内部已经显示消息
}
return true;
```

### 手机号验证
```javascript
if (!value || value.trim() === '') {
    formAPI.showMessage('手机号不能为空', 'error');
    return false;
}
if (!formAPI.validatePhone(value)) {
    return false;  // validatePhone 内部已经显示消息
}
return true;
```

### 两次密码一致性验证
```javascript
var password = formAPI.getControlValue('password');
if (value !== password) {
    formAPI.showMessage('两次密码输入不一致', 'error');
    return false;
}
return true;
```
